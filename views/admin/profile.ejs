<!-- Admin Profile Page -->


<div class="overflow-y-auto h-[calc(100vh-64px)]">
  <div class="p-6">
    <div class="max-w-2xl mx-auto">
      <!-- Profile Header Card -->
      <div class="card mb-6">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-900 dark:to-blue-800 h-32 rounded-t-lg"></div>
        
        <div class="card-body">
          <div class="flex flex-col md:flex-row gap-6">
            <!-- Profile Avatar -->
            <div class="flex flex-col items-center -mt-20">
              <img id="profilePreview" src="<%= admin.profile || 'https://ui-avatars.com/api/?name=' + admin.full_name + '&background=0D8ABC&color=fff&rounded=true&size=150' %>" alt="Profile" class="w-32 h-32 rounded-full border-4 border-white dark:border-slate-800 shadow-lg object-cover">
              <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">Admin Account</p>
            </div>

            <!-- Profile Info -->
            <div class="flex-1 mt-4 md:mt-12">
              <h2 class="text-2xl font-bold text-slate-900 dark:text-white"><%= admin.full_name %></h2>
              <p class="text-slate-600 dark:text-slate-400"><%= admin.email %></p>
              <% if (admin.phone) { %>
                <p class="text-slate-600 dark:text-slate-400 flex items-center gap-2 mt-2">
                  <i class="fas fa-phone w-4 h-4"></i>
                  <%= admin.phone %>
                </p>
              <% } %>
              <% if (admin.bio) { %>
                <p class="text-slate-600 dark:text-slate-400 mt-3"><%= admin.bio %></p>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Profile Form -->
      <div class="card">
        <div class="card-header">
          <h5>Edit Profile</h5>
        </div>
        
        <div class="card-body">
          <form id="profileForm" action="/profile" method="PATCH" enctype="multipart/form-data">
            <!-- Profile Picture Upload -->
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Profile Picture</label>
              <div class="flex items-center gap-4">
                <div class="relative">
                  <input type="file" id="profileInput" name="profile" accept="image/*" class="hidden">
                  <button type="button" onclick="document.getElementById('profileInput').click()" class="px-4 py-2 text-white bg-blue-500 hover:bg-blue-600 rounded transition flex items-center gap-2">
                    <i class="fas fa-camera"></i> Change Photo
                  </button>
                </div>
                <span class="text-sm text-slate-500 dark:text-slate-400">JPEG, PNG, GIF (Max 5MB)</span>
              </div>
            </div>

            <!-- Full Name -->
            <div class="mb-4">
              <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Full Name *</label>
              <input type="text" name="full_name" value="<%= admin.full_name %>" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>

            <!-- Email -->
            <div class="mb-4">
              <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Email Address *</label>
              <input type="email" name="email" value="<%= admin.email %>" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>

            <!-- Phone -->
            <div class="mb-4">
              <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Phone Number</label>
              <input type="tel" name="phone" value="<%= admin.phone || '' %>" placeholder="+1 (555) 123-4567" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Bio -->
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Bio</label>
              <textarea name="bio" rows="4" placeholder="Tell us about yourself..." class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"><%= admin.bio || '' %></textarea>
            </div>

            <!-- Password Section -->
            <div class="border-t border-slate-200 dark:border-slate-600 pt-6 mb-6">
              <h6 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Change Password</h6>
              
              <!-- Current Password -->
              <div class="mb-4">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Current Password</label>
                <input type="password" name="currentPassword" id="currentPassword" placeholder="Enter your current password" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>

              <!-- New Password -->
              <div class="mb-4">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">New Password</label>
                <input type="password" name="newPassword" id="newPassword" placeholder="Enter new password (leave blank to keep current)" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>

              <p class="text-sm text-slate-500 dark:text-slate-400">Password must be at least 6 characters long</p>
            </div>

            <!-- Form Actions -->
            <div class="flex gap-3">
              <button type="submit" class="px-6 py-2 text-white bg-blue-500 hover:bg-blue-600 rounded transition font-medium">
                <i class="fas fa-save mr-2"></i> Save Changes
              </button>
              <button type="reset" class="px-6 py-2 text-slate-700 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded transition font-medium">
                <i class="fas fa-times mr-2"></i> Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sidebar Toggle Script -->
<script src="/js/sidebar-toggle.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const profileForm = document.getElementById('profileForm');
  const profileInput = document.getElementById('profileInput');
  const profilePreview = document.getElementById('profilePreview');

  // Check if elements exist
  if (!profileForm) {
    console.error('Profile form not found!');
    return;
  }

  // Profile image preview
  if (profileInput) {
    profileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          profilePreview.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // Form submission
  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validate passwords if new password is provided
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;

    if (newPassword && !currentPassword) {
      showNotification('Please enter your current password to change password', 'error');
      return;
    }

    if (newPassword && newPassword.length < 6) {
      showNotification('New password must be at least 6 characters long', 'error');
      return;
    }

    const formData = new FormData(profileForm);
    
    // Debug: Log form data
    console.log('Form data being sent:');
    for (let [key, value] of formData.entries()) {
      console.log(`  ${key}:`, value);
    }

    try {
      const response = await fetch('/profile', {
        method: 'PATCH',
        body: formData,
        credentials: 'include'  // Include cookies in the request
      });

      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);

      // Check if response is OK (status 200-299)
      if (!response.ok) {
        const errorText = await response.text();
        console.error('HTTP Error:', response.status, errorText);
        showNotification('Server error: ' + response.status, 'error');
        return;
      }

      const result = await response.json();
      console.log('Response result:', result);

      if (result.success) {
        showNotification('Profile updated successfully!', 'success');
        // Reset password fields
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        // Reload page after 1.5 seconds to reflect changes
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('Error updating profile: ' + error.message, 'error');
    }
  });

  // Notification system
  function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 animate-fade-in ${
      type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('animate-fade-out');
      setTimeout(() => notification.remove(), 300);
    }, 2500);
  }

  // Profile menu toggle
  const profileBtn = document.getElementById('profileBtn');
  const profileMenu = document.getElementById('profileMenu');

  if (profileBtn && profileMenu) {
    profileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      profileMenu.classList.toggle('opacity-0');
      profileMenu.classList.toggle('invisible');
    });

    document.addEventListener('click', (e) => {
      if (!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) {
        profileMenu.classList.add('opacity-0', 'invisible');
      }
    });
  }
}); // Close DOMContentLoaded event
</script>
